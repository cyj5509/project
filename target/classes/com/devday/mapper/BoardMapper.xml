<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.devday.mapper.BoardMapper">

<!-- 글 쓰기 저장 ─ parameterType="" -->
<insert id="register" parameterType="com.devday.domain.BoardVO">
	INSERT INTO 
   		board_table (bd_number, bd_type, us_id, bd_title, bd_content, bd_register_date)
	VALUES
		(sequence_bd_number.NEXTVAL, #{bd_type}, #{us_id}, #{bd_title}, #{bd_content}, sysdate)
</insert>

<!-- 전체 목록(여러 개) ─ resultType="" -->
<select id="getList" resultType="com.devday.domain.BoardVO">
	SELECT
		bd_number, bd_type, us_id, bd_title, bd_content, bd_register_date, bd_update_date, bd_view_count
	FROM
		board_table
	ORDER BY
		bd_number DESC
</select> 

<!-- 동적 쿼리 ─ 공통된 SQL 구문 작업을 하기 위한 용도: 검색 조건 -->
<sql id="criteria">
	<trim prefix="(" suffix=") AND" prefixOverrides="OR">
	<!-- collection은 getTypeArr() 메서드 호출, item은 의미 없음 -->
    	<foreach collection="typeArr" item="type">
			<trim prefix="OR">
			    <choose>
			        <when test="type == 'T'.toString()">
			            bd_title LIKE '%' || #{keyword} || '%' 
			        </when>
			        <when test="type == 'W'.toString()">
			            us_id LIKE '%' || #{keyword} || '%' 
			        </when>
			        <when test="type == 'C'.toString()">
			            bd_content LIKE '%' || #{keyword} || '%' 
			        </when>
			    </choose>
			</trim>
    	</foreach>
	</trim>
</sql>

<!-- 페이징 목록(여러 개) ─ resultType="" -->
<!-- CDATA 섹션: XML 관점에서 적합한지에 대해 문법 검사를 하지 않음 -->
<select id="getListWithPaging" resultType="com.devday.domain.BoardVO" parameterType="com.devday.dto.Criteria">
	<![CDATA[
	SELECT
		bd_number, bd_type, us_id, bd_title, bd_content, bd_register_date, bd_update_date, bd_view_count
	FROM 
		(
	    SELECT /*+ INDEX_DESC(board_table pk_bd_number) */
	    		ROWNUM rn, bd_number, bd_type, us_id, bd_title, bd_content, bd_register_date, bd_update_date, bd_view_count
	    FROM
	    		board_table 
	    WHERE
			]]>
			<include refid="criteria"></include> 
			<![CDATA[
	     	ROWNUM <= #{pageNum} * #{amount}
	    )
	WHERE
		rn > (#{pageNum} - 1) * #{amount}
	]]>
</select>

<!--  전체 데이터 개수 -->
<select id="getTotalCount" resultType="int">
	SELECT
		COUNT(*)
	FROM
		board_table
	WHERE 
		<include refid="criteria"></include> bd_number > 0
</select>

<!-- 하나의 게시물 읽기 또는 글 수정 폼 -->
<select id="get" resultType="com.devday.domain.BoardVO" parameterType="Long">
	SELECT
		bd_number, bd_type, us_id, bd_title, bd_content, bd_register_date, bd_update_date, bd_view_count 
	FROM
		board_table
	WHERE
		bd_number = #{bd_number}
</select>

<!-- 조회수 증가 -->
<update id="readCount" parameterType="Long">
	UPDATE
		board_table
	SET
		bd_view_count = bd_view_count + 1
	WHERE
		bd_number = #{bd_number}
</update>

<!-- 글 수정하기 -->
<update id="modify" parameterType="com.devday.domain.BoardVO">
	UPDATE
		board_table
	SET
		bd_title = #{bd_title},
		bd_content = #{bd_content},
		bd_update_date = SYSDATE,
		bd_type = #{bd_type}
	WHERE
		bd_number = #{bd_number}
</update>

<!-- 글 삭제하기 -->
<delete id="delete" parameterType="Long">
	DELETE FROM
		board_table
	WHERE
		bd_number = #{bd_number}
</delete>

<!-- 게시판 타입별 구분 -->
<select id="getListType" resultType="com.devday.domain.BoardVO" parameterType="String">
	SELECT
		bd_number, bd_type, us_id, bd_title, bd_content, bd_register_date, bd_update_date, bd_view_count
	FROM
		board_table
	WHERE
		bd_type = #{bd_type}	
</select>


</mapper>